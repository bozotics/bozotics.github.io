name: Build and deploy Jekyll site to GitHub Pages

on:
  push:
    branches:
      - source

jobs:
  github-pages:
    runs-on: ubuntu-16.04
    steps:
      - name: 📂 checkout
        uses: actions/checkout@v2

      - id: find
        name: 📂 find jekyll directory
        run: |
          JEKYLL_SRC=$(find . -path ./vendor/bundle -prune -o -name _config.yml -exec dirname {} \; | tr -d '\n')
          JEKYLL_HASH=$(ls -alR --full-time ${JEKYLL_SRC} | sha1sum)
          echo "::set-output name=jekyllSrc::${JEKYLL_SRC}"
          echo "::set-output name=jekyllHash::${JEKYLL_HASH}"

      - name: 📝 cache bundler files
        uses: actions/cache@v1
        with:
          path: vendor/bundle
          key: bundle-use-ruby-${{ runner.os }}-2.7-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            bundle-use-ruby-${{ runner.os }}-2.7-

      - name: 📝 cache jekyll files
        uses: actions/cache@v1
        with:
          path: ${{ steps.find.outputs.jekyllSrc }}/.jekyll-cache
          key: ${{ runner.os }}-jekyll-${{ steps.find.outputs.jekyllHash }}
          restore-keys: |
            ${{ runner.os }}-jekyll-

      - name: 💎 setup ruby 2.7
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7

      - name: 🔨 install dependencies & build site
        uses: limjh16/jekyll-action-ts@v2
        with:
          jekyll_src: ${{ steps.find.outputs.jekyllSrc }}

      - name: 🚀 deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          publish_branch: master
